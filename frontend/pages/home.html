<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Controladoria AW</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="stylesheet" href="../css/estilo_geral.css">
    <link rel="shortcut icon" href="../Imgs/logo.png" type="image/x-icon">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onclick="closeContextMenu()">

    <header id="titlebar">
        <div class="window-controls">
            <div class="control-btn close-btn" id="closeBtn" title="Fechar"><svg viewBox="0 0 10 10">
                    <path d="M1,1 L9,9 M9,1 L1,9" />
                </svg></div>
            <div class="control-btn min-btn" id="minBtn" title="Minimizar"><svg viewBox="0 0 10 2">
                    <path d="M0,1 L10,1" />
                </svg></div>
            <div class="control-btn max-btn" id="maxBtn" title="Maximizar"><svg viewBox="0 0 10 10">
                    <path d="M0,10 L10,0 M1,1 L9,9" />
                </svg></div>
        </div>
        <div class="app-title">CONTROLADORIA AW - HOME PAGE</div>
    </header>
    <div class="mobile-header-bar">
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
            <i class="fas fa-bars"></i>
        </button>
        <div style="font-weight:bold;">CONTROLADORIA AW</div>

        <button class="mobile-menu-btn" onclick="logout()" title="Sair">
            <i class="fas fa-power-off"></i>
        </button>
    </div>

    <div id="loading-screen" class="loading-screen hidden">
        <div class="loader-wrapper">
            <div class="truck-wrapper">
                <div class="truck">
                    <div class="truck-container"></div>
                    <div class="glases"></div>
                    <div class="bonet"></div>
                    <div class="base"></div>
                    <div class="base-aux"></div>
                    <div class="wheel-back"></div>
                    <div class="wheel-front"></div>
                    <div class="smoke"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const loggedUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        if (!loggedUser && window.location.protocol !== 'file:') window.location.href = 'login.html';
        const safeUser = loggedUser || { username: 'Admin', sector: 'recebimento', role: 'Administrador', subType: null };
        const userSector = (safeUser.sector || '').toLowerCase();
        const userRoleRaw = (safeUser.role || '').toString().toLowerCase();
        const userSubType = safeUser.subType;
        const isRecebimento = userSector === 'recebimento' || userRoleRaw.includes('admin') || userRoleRaw.includes('administrador');
        const isConferente = userSector === 'conferente';
        const isAdmin = userRoleRaw.includes('admin') || userRoleRaw.includes('administrador');
        const isEncarregado = userRoleRaw.includes('encarreg');
    </script>

    <nav class="main-sidebar">
        <div class="logo-area">
            <img src="../Imgs/logo-sf.png" alt="logo" style="width: 50px; height: 50px; border-radius:50%;">
            <span>CONTROLADORIA</span>
        </div>
        <div class="menu-items">
            <a class="menu-item active" id="menuPatio" onclick="navTo('patio', this)"><i class="fas fa-truck"></i>
                Controle de Pátio</a>
            <a class="menu-item" onclick="navTo('mapas', this)"><i class="fas fa-clipboard-check"></i> Mapas Cegos</a>
            <a class="menu-item" id="menuMateriaPrima" onclick="navTo('materia-prima', this)"><i
                    class="fas fa-weight-hanging"></i>Pesagem</a>
            <a class="menu-item" id="menuCarregamento" onclick="navTo('carregamento', this)"><i
                    class="fas fa-dolly"></i> Carregamento</a>
            <a class="menu-item" onclick="navTo('relatorios', this)"><i class="fas fa-chart-pie"></i> Relatórios</a>
            <a id="menuDashboard" class="menu-item" onclick="navTo('dashboard', this)"><i class="fas fa-chart-line"></i>
                Dashboard</a>
            <a id="menuCadastros" class="menu-item" onclick="navTo('cadastros', this)"><i class="fas fa-address-book"></i> Cadastros</a>
            <a class="menu-item" onclick="navTo('produtos', this)"><i class="fas fa-boxes"></i> Produtos</a>
            <a class="menu-item" id="menuNotif" onclick="navTo('notificacoes', this)"><i class="fas fa-bell"></i>
                Notificações <span class="notification-badge" id="badgeNotif">0</span></a>
            <a class="menu-item" onclick="navTo('perfil', this)"><i class="fas fa-user-circle"></i> Perfil / Admin</a>
            <div style="margin-top:auto; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1)">
                <a class="menu-item" onclick="navTo('configuracoes', this)"><i class="fas fa-cog"></i> Configurações</a>
            </div>
        </div>
        <div class="user-footer">
            <div
                style="width:35px; height:35px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; color:white;">
                <script>document.write(safeUser.username[0])</script>
            </div>
            <div style="overflow:hidden;">
                <div style="font-size:0.9rem; font-weight:600; white-space:nowrap;">
                    <script>document.write(safeUser.username)</script>
                </div>
                <div style="font-size:0.75rem; opacity:0.7;">
                    <script>document.write(safeUser.label || safeUser.sector)</script>
                </div>
            </div>
        </div>
    </nav>

    <main class="content-area">
        <header class="top-header">
            <h2 id="pageTitle" style="margin:0; font-size:1.4rem; font-weight:700; color:var(--text-main);">Painel de
                Pátio</h2>
            <div style="display:flex; gap:15px; align-items:center;">
                <div id="socketStatus" style="font-size:0.8rem; font-weight:bold; color: #ef4444; display:flex; align-items:center; gap:5px;">
                    <div style="width:8px; height:8px; background:currentColor; border-radius:50%;"></div>
                    Offline
                </div>
                <div id="serverTime" style="font-size:0.9rem; color:var(--text-muted);"></div>
                <button onclick="logout()" class="btn btn-edit"><i class="fas fa-power-off"></i> Sair</button>
            </div>
        </header>

        <div id="view-patio" class="view-section active">
            <!-- Conteúdo do Pátio -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:var(--bg-input); padding:15px; border-radius:8px; border:1px solid var(--border-color);">
                <div style="display:flex; gap:20px; align-items:center;">
                    <h3 style="margin:0; font-size:1.1rem; color:var(--text-main);">Gerenciamento de Pátio</h3>
                    <div style="background:var(--bg-card); padding:5px 15px; border-radius:20px; border:1px solid var(--border-color); font-size:0.9rem;">
                        Caminhões Ativos: <b id="totalTrucksBadge" style="color:var(--primary); font-size:1.1rem;">0</b>
                    </div>
                </div>
                <input type="date" id="patioDateFilter" onchange="renderPatio()" style="width:auto; border:1px solid #ccc;">
            </div>
            <div class="board-container">
                <div class="board-col" id="col-ALM">
                    <div class="col-header col-alm">DOCA (ALM) <span id="count-ALM">0</span></div>
                    <div class="col-body" id="list-ALM"></div>
                </div>
                <div class="board-col" id="col-GAVA">
                    <div class="col-header col-gava">GAVA (ALM) <span id="count-GAVA">0</span></div>
                    <div class="col-body" id="list-GAVA"></div>
                </div>
                <div class="board-col" id="col-OUT">
                    <div class="col-header col-out">OUTROS SETORES <span id="count-OUT">0</span></div>
                    <div class="col-body" id="list-OUT"></div>
                </div>
                <div class="board-col" id="col-SAIU">
                    <div class="col-header col-saiu">HISTÓRICO (HOJE)</div>
                    <div class="col-body" id="list-SAIU"></div>
                </div>
            </div>
            <div id="fabAddTruck" class="fab" onclick="modalTruckOpen()">+</div>
        </div>

        <div id="view-mapas" class="view-section">
            <div class="mc-layout">
                <div class="mc-sidebar-list" id="mobileMapList">
                    <div style="padding:15px; background:var(--bg-input); font-weight:bold; border-bottom:1px solid var(--border-color);">
                        Filtrar Mapas
                        <input type="date" id="mapListDateFilter" onchange="renderMapList()" style="width:100%; margin-top:10px;">
                    </div>
                    <div class="mc-list-items" id="mapList" style="flex:1; overflow-y:auto;"></div>
                    <div style="padding:10px;"><button onclick="createNewMap()" class="btn btn-save" style="width:100%; justify-content:center;">+ Novo Mapa Manual</button></div>
                </div>
                <div style="flex:1; overflow-y:auto; padding-bottom:50px; position:relative;">
                    <div id="mapEmptyState" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--text-muted); text-align:center; padding-top:100px;">
                        <i class="fas fa-wind" style="font-size:3rem; margin-bottom:20px; opacity:0.3;"></i>
                        <h3 style="margin:0; font-weight:600;">Nenhum mapa cego por aqui...</h3>
                        <p style="font-size:0.9rem; margin-top:5px; max-width:250px;">Selecione um item na lista ao lado ou crie um novo mapa.</p>
                    </div>
                    <div class="sheet" id="mapSheet" style="display:none;"></div>
                </div>
            </div>
        </div>

        <div id="view-materia-prima" class="view-section">
            <div id="mpContent"></div>
        </div>

        <div id="view-carregamento" class="view-section">
            <div id="carregamentoContent"></div>
        </div>

        <div id="view-relatorios" class="view-section">
            <div id="relatoriosContent"></div>
        </div>

        <div id="view-dashboard" class="view-section">
            <div id="dashboardContent"></div>
        </div>

        <div id="view-cadastros" class="view-section">
            <div id="cadastrosContent"></div>
        </div>

        <div id="view-produtos" class="view-section">
            <div id="productsContent"></div>
        </div>

        <div id="view-notificacoes" class="view-section">
            <div id="notificacoesContent"></div>
        </div>

        <div id="view-perfil" class="view-section">
            <div id="profileContent" style="padding:20px;"></div>
        </div>

        <div id="view-configuracoes" class="view-section">
            <div id="adminOnlyConfig" style="display:none; margin-bottom: 20px;">
                <div id="customModulesAdmin"></div>
            </div>
            <div class="settings-grid">
                <div class="settings-card">
                    <h4><i class="fas fa-database"></i> Backup e Sincronização</h4>
                    <p style="font-size:0.85rem; color:#666; margin-bottom:15px;">Gerencie os dados do sistema e realize backups manuais.</p>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-edit" onclick="exportData()"><i class="fas fa-download"></i> Exportar JSON</button>
                        <button class="btn btn-edit" onclick="importData()"><i class="fas fa-upload"></i> Importar JSON</button>
                        <button class="btn btn-edit" style="color:red; border-color:red;" onclick="resetSystem()"><i class="fas fa-trash-alt"></i> Resetar Tudo</button>
                    </div>
                </div>
                <div class="settings-card">
                    <h4><i class="fas fa-desktop"></i> Preferências de Exibição</h4>
                    <label class="checkbox-container">
                        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"> Modo Escuro (Dark Mode)
                    </label>
                    <label class="checkbox-container">
                        <input type="checkbox" id="fastModeToggle" onchange="toggleFastMode()"> Modo Desempenho (Sem Animações)
                    </label>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts de Módulos -->
    <script src="../js/modules/validators.js"></script>
    <script src="../js/modules/config.js"></script>
    <script src="../js/modules/data-sync.js"></script>
    <script src="../js/modules/notifications.js"></script>
    <script src="../js/modules/ui-navigation.js"></script>
    <script src="../js/modules/custom-modules.js"></script>
    <script src="../js/modules/patio.js"></script>
    <script src="../js/modules/cadastros.js"></script>
    <script src="../js/modules/mapas-cegos.js"></script>
    <script src="../js/modules/materia-prima.js"></script>
    <script src="../js/modules/carregamento.js"></script>
    <script src="../js/modules/relatorios.js"></script>
    <script src="../js/modules/dashboard.js"></script>
    <script src="../js/modules/users.js"></script>
    <script src="../js/modules/products.js"></script>
    <script src="../js/modules/main.js"></script>

    <script>
        // HACK: Electron define 'module' globalmente
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }

        const socketScript = document.createElement('script');
        socketScript.src = `${API_BASE_URL}/socket.io/socket.io.js`;
        socketScript.onload = function() {
            if (window.module) module = window.module;
            initRealTimeSystem(); 
        };
        document.head.appendChild(socketScript);

        function showLoading() { document.getElementById("loading-screen").classList.remove("hidden"); }
        function hideLoading() { document.getElementById("loading-screen").classList.add("hidden"); }
        window.onload = () => { 
            showLoading(); 
            setTimeout(hideLoading, 1500);
            
            // Inicialização extra para admin
            if (isAdmin) {
                const adminDiv = document.getElementById('adminOnlyConfig');
                if (adminDiv) adminDiv.style.display = 'block';
                if (typeof renderCustomModulesAdmin === 'function') renderCustomModulesAdmin();
            }
        };
    </script>
</body>
</html>
